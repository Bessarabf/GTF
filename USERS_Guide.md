# GTF 
## Программный комплекс анализа приливов и планетарных волн в модели GSM TIP
## Содержание


## Описание

Программный комплекс предназначен для обработки результатов моделирования Глобальной самосогласованной модели термосферы, ионосферы и протоносферы (ГСМ ТИП) с целью определения параметров планетарных и приливных волн, их спектрального анализа и выделения из данных моделирования отдельных гармоник. Комплекс включает в себя несколько специализированных программ, реализованных на языке FORTRAN77, объединённых в один исполняемый файл.

### Системные требования

Устойчивая работа комплекса обеспечивается на 64-разрядных операционных системах семейства Windows. Обработка данных осуществляется без распараллеливания вычислений на различные ядра процессора, а потому достаточно требовательна к производительности процессора. Продолжительность вычислений прямо зависит от объёмов обрабатываемых данных. Так, на процессоре Intel i5-4460 полная обработка результатов моделирования за месяц всем комплексом программ по 4 высотным и 7 широтным точкам занимает около часа. 

### Компиляция

Проект оттестирован при компиляции с помощью Intel Fortran (в сборке среды программирования Microsoft Visual Studio 2010). Для корректной компиляции в параметрах командной строки проекта (ПКМ=>Properties=>Configuration Properties=>Fortran=>Command Line) необходимо указать дополнительную опцию "/assume:byterecl" (без кавычек). При использовании компилятора от Microsoft (в среде Microsoft Fortran Power Station) может возникать проблема переполнения оперативной памяти. Используемый в текущей версии программы подход использования передаваемых в подпрограммы массивов нейтрализует эту проблему, однако финальная версия программы не тестировалась на иных компиляторах и её работоспособность при использовании Microsoft Fortran Power Station не гарантируется.

### Входные параметры

Комплекс предназначен для работы с почасовыми данными о параметрах среды, получаемыми из ГСМ ТИП. Набор данных за каждый день в формате часовых файлов вида file4.01, file4.02, file4.03 … file4.24 должен быть помещён в нумерованные папки с именами, соответствующими номерам дней месяца, по типу 01, 02, 03 … 31. Предусмотрена возможность считывать данные из файлов вида file4_ddd.hh, где ddd - день года, например, 003, 011, 231 и т.д.; hh - UT время в часах. В этом случае дополнительные папки для хранения файлов по дням не требуются. Выбор способа обращения к данным в файлах file4 происходит в блоке TIDE. Путь к каталогу с этими папками должен содержать только стандартные символы и латинские буквы и не превышать 120 знаков.

Все генерируемые программным комплексом результаты сохраняются в директории с исходным набором данных от ГСМ ТИП. В связи с этим, в этой директории должны быть открыты права на чтение и запись файлов, а также должно иметься достаточно свободного дискового пространства для записи новых данных. Полный набор данных от всех программ комплекса, обработавших результаты моделирования за месяц, имеет объём около 9 ГБ. Каждый дополнительный параметр в обработке блоками PWSTR, HPW  и TideSTR добавляет около 200 МБ. 

Алгоритмы работы комплекса достаточно универсальны, чтобы обрабатывать любые произвольные наборы данных, структурированные определённым образом. Однако, при работе с данными не из файлов типа file4 необходимо использовать альтернативный способ ввода данных. Настоящая сборка программы ориентирована на её использование для обработки данных, полученных с помощью GSMTIPViewer, в частности компонетов электрического поля и TEC, и подразумевает расположение указанных данных в папках соответствующих январю 2009 года (см. описание GSMTIPViewer). Для этого в общий перечень параметров ГСМ ТИП были добавлены 22, 23 и 24 параметры (см. раздел TIDE_alt), а в блоках GTF и TIDE\_alt указан соответствующий путь к папке с данными. В случае, если программу предполагается использовать только для анализа стандартных 19 параметров ГСМ ТИП из file4, никаких изменений вносить не требуется, дополнительные параметры будут игнорироваться. В случае, если программу предполагается использовать для анализа данных из других источников, потребуется существенное изменение указанных блоков.

### Ввод параметров

Параметры обработки данных вводятся в файл info.txt. В самом файле имеются комментарии, указывающие, в каком порядке вводить параметры. Пример содержимого файла info.txt:

19 # Количество параметров ГСМ ТИП, записанных в file4
30 # Количество узлов сетки по высотам
72 # Количество узлов сетки по долготам
37 # Количество узлов сетки по широтам
24 # Количество узлов сетки по времени в сутки
2 # Размерность массива амплитуда-фаза
5 # Шаг сетки по широте
5 # Шаг сетки по долготе
1 # Признак запуска блока TIDE: 0 – не запускается, 1 – запускается
1 # Признак запуска блока PWSTR: 0 – не запускается, 1 – запускается
1 # Признак запуска блока HPW: 0 – не запускается, 1 – запускается
1 # Признак запуска блока PWWE: 0 – не запускается, 1 – запускается
1 # Признак запуска блока TideSTR: 0 – не запускается, 1 – запускается
1 # Признак считывания: 0 – посуточная нумерация, 1 – сквозная нумерация
0 # Признак формата: 0 – данные от ГСМ ТИП, 1 – альтернативные данные
D:\Data\New_data\EAGLE-120 # Путь к папке с данными ГСМ ТИП
D:\Data\New_data\EAGLE-120\2009\01 # Путь к папке с данными в альтернативном формате
2 # Номер первого дня в обрабатываемом интервале
30 # Номер последнего дня в обрабатываемом интервале
7 # Номер обрабатываемого параметра
1,0,0,0,0,0,0 # 7 номеров широтных точек через запятую, 0 – пропуск точки
9,0,0,0 # 4 номера высотных точек через запятую, 0 – пропуск точки

Первые восемь параметров в файле являются техническими и для стабильной версии ГСМ ТИП с 19 записываемыми параметрами и сеткой 5 на 5 градусов по широтам и долготам не меняются. Признаки запусков отдельных программных блоков предназначены для выборочного применения отдельных алгоритмов к ранее обработанным данным. 

Параметры распределены по номерам следующим образом:

1 – концентрация O2

2 – концентрация N2

3 – концентрация O

4 – концентрация NO

5 – концентрация N

6 – концентрация Mol+

7 – Температура нейтральных частиц, К

8 – Температура ионов, К

9 – Температура электронов, К

10 – Вертикальная скорость, см/с

11 – Меридиональная скорость, см/с

12 – Зональная скорость, см/с

13 – Скорость ионизации O2+, 1/см2/с

14 –  Скорость ионизации N2+, 1/см2/с

15 –  Скорость ионизации NO+, 1/см2/с

16 –  Скорость ионизации O+, 1/см2/с

17 –  Концентрация N(2D), см-3

18 –  Температура горячего кислорода [^1]

19 – Концентрация горячего кислорода

20 – Электронная концентрация

21 – 

22 – Зональная компонента электрического поля, мВ/м

23 – Меридиональная компонента электрического поля, мВ/м

24 – TEC

[^1]: в новых версиях file4 параметры горячего кислорода заменены концентрациями O2+ и NO+

### Структура программы

#### Блок GTF

Блок GTF предназначен для считывания параметров запуска и передачи их в блоки анализа в необходимой последовательности. Основная программа считывает info-файл и на основании полученной из него информации запускает блок TIDE или блок TIDE\_alt, а затем вызывает подпрограмму startpr.

Подпрограмма startpr отвечает за последовательный запуск блоков анализа приливных и планетарных волн в соответствии со считанными параметрами. Каждый из блоков запускается при условии наличия соответствующего признака запуска, при этом блок PWWE запускается до семи раз (для семи различных широт, заданных в info-файле), а блок TideSTR – до четырёх раз (для четырёх различных высот). Следует отметить, что в конечные блоки передаются только значения параметров, а не массивы, а потому при необходимости увеличения количества обрабатываемых широт или высот достаточно увеличить размерность соответствующего массива и добавить его элементы в блок чтения info-файла.

#### Блок TIDE

Блок предназначен для чтение файлов формата file4, перевода параметров из геомагнитной сетки в географическую, выделения приливных и планетарных вариаций и записи полученных результатов в отдельные файлы. Блок устроен таким образом, что все процедуры выполняются циклично, для каждого из дней заданного интервала. Строки 77-78 определяют выбор способа расположения файлов с данными: в папках по дням или пронумерованными в прямом порядке. Ненужный способ считывания следует держать закомментированным.

Ключевым является массив pgl, формируемый в ходе выполнения подпрограммы formPGL\_PGI. В него записываются все параметры, считываемые из файлов file4. Далее полученный массив пересчитывается из геомагнитных в географические координаты посредством подпрограммы filegeo.

Подпрограмма tides предназначена для формирования массивов данных по приливным волнам. Результатом её выполнения является трёхмерное распределение амплитуд и фаз приливов с периодами 24, 12 и 8 часов в каждом из параметров, записанное в пятимерных массивах (номер параметра, амплитуда или фаза, номер высотной, коширотной и долготной точки) tide24, tide12 и tide8 соответственно.

Подпрограмма means предназначена для формирования массивов данных по планетарным волнам. Её результатом является аналогичные распределения для планетарных волн, записанные в четырёхмерных массивах sutut, sutlt, sutj для всемирного, местного времени, а также выборки долгот соответственно. В массивы dsutut, dsutlt, dsutj записываются среднеквадратичные отклонения соответствующих параметров.

Созданные этими подпрограммами массивы дополняются значениями параметров на полюсах с помощью подпрограмм bongi и bongi2, и полученные результаты записываются в файлы с соответствующими именами.

#### Блок TIDE_alt

Блок полностью аналогичен блоку TIDE и предназначен для чтения исходных данных о зональной и меридиональной компонентах электрического поля, а также TEC из результатов обработки с помощью программы GSMTIPViwer. Пути к данным и логика формирования из них стандартных для всего программного комплекса массивов обусловлены форматом генерируемых GSMTIPViwer данных и ориентированы исключительно на указанные параметры.

Блок TIDE\_alt запускается только в тех случаях, когда номер обрабатываемого параметра соответствует вышеуказанным параметрам. Для его корректной работы необходимо наличие в корневой папке с данными, путь к которой указан в info.txt вложенной папки 2009/01, в которой находятся папки, пронумерованные по дням месяца. В каждой из них должна находится вложенная папка quiet, включающая в себя исходные данные в файлах типа file4, а также автоматически генерируемые GSMTIPViwer подпапки с данными.

Для ускорения вычислений и ограничения размерности массивов, в указанной вложенной папке данные записываются в подпапки par01, par02 и par03 для 22, 23 и 24 параметров соответственно. Так как распределения компонент электрического поля и TEC понимаются двумерными, понятие фиксированной высоты не имеет смысла, а потому, для упрощения, в дальнейшем все данные пишутся для высоты 01.

#### Блок PWSTR

Блок предназначен для выделения из планетарной активности отдельных планетарных волн с различными зональными волновыми числами. Процедуры выполняются циклично для всех дней в заданном интервале. Основная программа считывает данные из файлов sutut, sutlt и sutj, после чего вызывается подпрограмма strucpw, в которой данные обрабатываются путём применения над ними дискретного преобразования Фурье. Полученные значения фонового состояния (нулевой гармоники) и первых пяти гармоник записываются в файлы PW0-n...PW5-n, где n – номер рассматриваемого дня.

#### Блок HPW

Блок предназначен для построения двумерных пространственных структур планетарных вариаций на фиксированной широте и фиксированной высоте. В силу технических ограничений в блоке создана подпрограмма HPW0, в которой фактически и происходит расчёт. После считывания данных из файлов PWi-n производится цикличный запуск подпрограмм PWH и PWZ для заданных в info-файле высот и широт соответственно. Каждая из них осуществляет выборочную запись данных в двумерные массивы, пригодные для визуализации.

#### Блок PWWE

Блок выделяет планетарные волны, бегущие в западном и восточном направлениях. Состоит из двух подпрограмм – технической RW1, предназначенной для чтения-записи данных и pwwestr, в которой осуществляется вычисление интеграла Фурье по номерам гармоник, с разделением результатов на восточную (для положительных номеров гармоник) и западную (для отрицательных номеров) волны. Полученные значения амплитуд и фаз волн записываются в файлы PEast.dat и PWest.dat соответственно.

#### Блок TideSTR

Блок TideSTR предназначен для аналогичной обработки приливных вариаций и включает в себя чтение исходных данных, вызов подпрограммы ppo, производящей преобразование Фурье над ними, и запись выходных данных. В результате исполнения блока формируются следующие файлы: par8.dat, par12.dat, par24.dat с амплитудами и фазами приливных вариаций с периодами 8, 12 и 24 часа соответственно, spec8.dat, spec12.dat, spec24.dat с разложением соответствующих волн по 11 гармоникам (от -5 до 5 включительно), а также общие файлы с распределением амплитуд и фаз приливов по Гринвичу PARut.dat, местному времени PARlt.dat, а также по широтам PARj.dat.

#### Запуск отдельных блоков

Следует заметить, что описанная выше процедура ввода параметров в полной мере актуальна только для произведения всего комплекса операций над исходными данными формата file4. В случае, если необходимо выполнить только определённые вычисления, возможен запуск программных блоков по отдельности.

Для запуска любого блока необходимо задать путь к каталогу с данными в вышеуказанном формате, интервал дней, включаемых в рассмотрение, а также выбрать параметр, данные по которому будут обрабатываться. Кроме этого, для корректной работы каждой из программ необходимо задать некоторые дополнительные параметры, а также убедиться в наличии входных данных нужного типа.

| Название | Параметры | Входные данные | Выходные данные |
| --- | --- | --- | --- |
| TideAnalise | =//= | file4 | sutj, sutlt, sutut, tide8, tide12, tide24 |
| PWSTR | =//= | sutj, sutlt, sutut, tide8, tide12, tide24 | PWn-d |
| HPW | широта, высоты 1,2,3,4 | PWn-d | PWnH, PWnh1, PWnh2, PWnh3, PWnh4, PWnh5 |
| PWWE | номер гармоники | PWn-d | PW0, PWest, PEast |
| Tidestr | высота | sutj, sutlt, sutut, tide8, tide12, tide24 | spec8-d, spec12-d, spec24-d, PAR8-d, PAR12-d, PAR24-d, PARj-d, PARj-d, PARlt-d |

здесь n – волновое число от 0 (для PWWE – 1) до 5, d – номера дней из заданного интервала.

#### Вспомогательные программы

Запись данных всех вышеупомянутых блоков осуществляется в dat-файлы в виде трёх- и четырёхмерных массивов в очерёдности, определяемой логикой обработки данных. Однако для целей визуализации результатов в форме графиков и двумерных распределений возникает необходимость подготавливать специальные файлы, отражающие нужные данные. В зависимости от задачи, такие файлы могут включать в себя различные «срезы» данных, как правило, в виде двумерных массивов. Зачастую их формирование требует неоднократного запуска основных блоков обработки данных, чтобы получить файлы за различные интервалы дней и высот. С учётом разнообразия возможных форматов вывода данных для различных задач, а также фактического отсутствия преобразования считываемых данных (все эти программы производят выборку из ранее сгенерированных массивов по тем или иным переменным), они реализованы в виде отдельных небольших программ, использующих info-файл того же формата, что и сам обработчик. Существуют следующие программы:

* TideAmp – программа, предназначенная для формирования файлов с широтно-временным распределением амплитуд и фаз отдельных гармоник в составе приливов. По умолчанию формирует файлы spec-8.dat, spec-12.dat и spec-24.dat со сведениями о 8-, 12- и 24-часовых солнечно мигрирующих приливах соответственно, однако, используя предусмотренный в коде альтернативный вывод (строка 141) можно записывать данные о любой произвольной немигрирующей гармонике. 
* SpecH – программа, предназначенная для формирования файлов с высотно-временным распределением амплитуд и фаз отдельных гармоник в составе приливов. В остальном полностью аналогична предыдущей.
* SpecT – программа, предназначенная для построения спектров приливов в координатах время-номер гармоники. Файлы данных формируются на фиксированных высотах и широтах в соответствии с info-файлом, и записываются в отдельную папку spect с маркировкой по периодам приливов и номерам широтных узлов.
* SpecPW – программа, предназначенная для построения спектров планетарных волн в координатах время-номер гармоники. Файлы данных формируются на фиксированных высотах и широтах в соответствии с info-файлом, и записываются в отдельную папку specpw с маркировкой по номерам высотных и широтных узлов.
